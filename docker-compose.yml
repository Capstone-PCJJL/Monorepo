# =============================================================================
# Monorepo Docker Compose
# =============================================================================
#
# LOCAL URLS:
#
#   Frontend:   http://localhost:3000
#   Backend:    http://localhost:8000
#   API Docs:   http://localhost:8000/api/docs
#   MySQL:      localhost:3306
#
# SWITCHING DATABASES - Just change DB_MODE in .env:
#
#   DB_MODE=local   -> Uses LOCAL_SQL_* variables (Docker MySQL)
#   DB_MODE=remote  -> Uses REMOTE_SQL_* variables (AWS RDS)
#
# COMMANDS:
#
#   Local Development (Docker MySQL):
#     make up-local                           # Start all with local DB
#     make down-local                         # Stop all services
#     make restart-local                      # Restart all services
#     make clean-local                        # Stop + delete volumes + prune
#
#   Remote/Production (AWS RDS):
#     make up-remote                          # Start frontend + backend only
#     make down-remote                        # Stop frontend + backend
#     make restart-remote                     # Restart frontend + backend
#     make clean-remote                       # Remove frontend + backend containers
#
#   Other:
#     make logs                               # Follow container logs
#
#   Docker Compose (alternative):
#     docker-compose --profile local up -d    # Start all with local DB
#     docker-compose up backend frontend -d   # Start frontend + backend only (AWS RDS)
#     docker-compose down                     # Stop all services
#     docker-compose down -v                  # Stop + delete database volume
#
#   Clean up / Clear cache:
#     docker system prune                     # Remove unused containers, networks, images
#     docker system prune -a                  # Remove ALL unused images (reclaim space)
#     docker volume prune                     # Remove unused volumes
#     docker builder prune                    # Clear build cache
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MySQL Database (LOCAL DEVELOPMENT ONLY)
  # ---------------------------------------------------------------------------
  # This service is OPTIONAL - only needed when using local database.
  # On first start, creates tables from docker/mysql/init/01-schema.sql
  # The seeder service then populates data from AWS RDS.
  #
  # To use AWS RDS instead, skip this service:
  #   docker-compose up backend frontend -d
  # ---------------------------------------------------------------------------
  db:
    profiles: [local]
    image: mysql:8
    container_name: monorepo-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${LOCAL_SQL_PASS:-password}
      MYSQL_DATABASE: ${LOCAL_SQL_DB:-tmdb}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Database Seeder (runs once on first start)
  # ---------------------------------------------------------------------------
  # Automatically seeds local MySQL with ~5k movies from AWS RDS.
  # Only runs if the movies table is empty, safe to run repeatedly.
  # To re-seed (after schema changes): docker-compose run --rm seeder --force
  # ---------------------------------------------------------------------------
  seeder:
    profiles: [local]
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: monorepo-seeder
    command: ["seed", "--limit", "5000"]
    environment:
      # Local Docker database (connects via Docker network)
      - LOCAL_SQL_HOST=db
      - LOCAL_SQL_PORT=3306
      - LOCAL_SQL_USER=${LOCAL_SQL_USER:-root}
      - LOCAL_SQL_PASS=${LOCAL_SQL_PASS:-password}
      - LOCAL_SQL_DB=${LOCAL_SQL_DB:-tmdb}
      # Remote AWS RDS (source for seed data)
      - REMOTE_SQL_HOST=${REMOTE_SQL_HOST}
      - REMOTE_SQL_PORT=${REMOTE_SQL_PORT:-3306}
      - REMOTE_SQL_USER=${REMOTE_SQL_USER}
      - REMOTE_SQL_PASS=${REMOTE_SQL_PASS}
      - REMOTE_SQL_DB=${REMOTE_SQL_DB:-movie_capstone_db}
    volumes:
      # Persist seed backup locally (survives docker prune)
      - ./apps/backend/data:/app/data
    depends_on:
      db:
        condition: service_healthy
    restart: "no"

  # ---------------------------------------------------------------------------
  # Backend API & Pipeline
  # ---------------------------------------------------------------------------
  # Works with either local Docker database or AWS RDS.
  # Database connection is configured via environment variables in .env
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: monorepo-backend
    restart: unless-stopped
    command: api
    environment:
      - API_KEY=${API_KEY}
      - TMDB_BEARER_TOKEN=${TMDB_BEARER_TOKEN}
      - BASE_URL=${BASE_URL:-https://api.themoviedb.org/3}
      # Database mode: "local" or "remote"
      - DB_MODE=${DB_MODE:-local}
      # Local Docker database (uses "db" service name in Docker network)
      - LOCAL_SQL_HOST=db
      - LOCAL_SQL_PORT=3306
      - LOCAL_SQL_USER=${LOCAL_SQL_USER:-root}
      - LOCAL_SQL_PASS=${LOCAL_SQL_PASS:-password}
      - LOCAL_SQL_DB=${LOCAL_SQL_DB:-tmdb}
      # Remote AWS RDS database
      - REMOTE_SQL_HOST=${REMOTE_SQL_HOST}
      - REMOTE_SQL_PORT=${REMOTE_SQL_PORT:-3306}
      - REMOTE_SQL_USER=${REMOTE_SQL_USER}
      - REMOTE_SQL_PASS=${REMOTE_SQL_PASS}
      - REMOTE_SQL_DB=${REMOTE_SQL_DB:-movie_capstone_db}
      # API config
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    ports:
      - "8000:8000"

  # ---------------------------------------------------------------------------
  # Frontend (Development with Vite)
  # ---------------------------------------------------------------------------
  frontend:
    image: node:20-alpine
    container_name: monorepo-frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    environment:
      - API_PROXY_TARGET=${API_PROXY_TARGET:-http://backend:8000}
      - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}
      - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}
      - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}
      - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}
      - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}
      - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}
      - VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}
    ports:
      - "3000:3000"
    volumes:
      - ./apps/frontend:/app
      - /app/node_modules
    depends_on:
      - backend

volumes:
  mysql_data:
